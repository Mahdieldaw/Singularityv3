# Singularity V3: Cognitive Pipeline Architectural Walkthrough

This document provides a comprehensive overview of the transition from the original "Linear Synthesis" architecture to the new **Interactive Cognitive Pipeline**. This shift evolves Singularity from a parallel model aggregator into a sophisticated reasoning engine that triages information and empowers user-driven exploration.

---

## 1. System Philosophy: Linear → Pipeline

The original architecture followed a straight-line flow: `Batch Fan-Out` → 

Mapping → 

Synthesis → `Display`

The new architecture introduces a **Triage & Branching** model:

1. **Foundation**: Parallel model fan-out.
2. **Analysis**: Mapper V2 structure + Explore Topological Triage.
3. **Cognitive Halt**: A deliberate pause where the user chooses the reasoning lens.
4. **Specialized Execution**: Understand (High-fidelity answer) or Decide (Stress-testing).

---

## 2. The 21 Key Files & Components

The following files and components were created or fundamentally transformed to implement this new architecture:

### Shared & Data Layer

1. **
    
    contract.ts**: Entirely redefined to support 
    
    MapperArtifact, 
    
    ExploreAnalysis, 
    
    UnderstandOutput, and 
    
    GauntletOutput interfaces.
2. **
    
    parsing-utils.ts**: Implemented specialized parsers for the new structured outputs (Mapper V2, Understand, etc.).
3. **
    
    types/index.ts**: Updated 
    
    AiTurn to hold the new cognitive state and version trackers.
4. **
    
    turn-helpers.ts**: Integrated normalization for the new cognitive response types.

### Core Logic (Backend)

5. **
    
    workflow-engine.js**: Orchestrates the multi-stage pipeline, implements `Cognitive Halt` logic, and handles workflow resumption.
6. **
    
    PromptService.ts**: Contains the sophisticated prompts for Mapper V2, Explore, Understand, and the Gauntlet.
7. **
    
    explore-computer.ts**: [NEW] Performs topological triage to select the optimal Explore container.
8. **
    
    explore-computer/index.ts**: [NEW] Exports the cognitive computing modules.
9. **
    
    connection-handler.js**: Implemented routing for `CONTINUE_COGNITIVE_WORKFLOW` messages.

# Singularity V3: The Cognitive Pipeline Architectural Walkthrough

This document maps the evolution of Singularity from a **Linear Response Aggregator** (V1/V2) to a structured **Cognitive Pipeline** (V3). It details the 23 new files and critical modifications required to realize the vision outlined in the new architecture specification.

---

## 1. Architectural Shift: Linear → Topological

In the original architecture, models were queried in parallel, and a single synthesis was generated. In V3, the system introduces a **Semantic Analysis Layer (Mapper V2)** that determines the complexity of the answer space before any synthesis occurs.

### Comparison

|Feature|Original (V1/V2)|Cognitive Pipeline (V3)|
|---|---|---|
|**Workflow**|Linear Fan-out → Synthesis|Triaged Branching (Foundation → Triage → Specialized Lens)|
|**Mapper**|Prose extraction / Citations|3-Pass Semantic Extraction + Topological Classification|
|**Synthesis**|Single combined answer|Framework-driven (Understand/One-Echo) or Gauntlet|
|**UX Pattern**|Auto-stream all|Cognitive Halt (User chooses the reasoning mode)|

---

## 2. New File Inventory (23 Total)

To implement this pipeline, the following 23 files were introduced, organized by their functional domains:

### Core Cognitive Logic (2 Files)

- explore-computer.ts: Performs topological analysis of the Mapper Artifact.
- src/core/cognitive/index.ts: Orchestration entry point.

### Specialized Cognitive Views (8 Files)

- PostMapperView.tsx: The "Choice Point" where users choose their cognitive mode.
- UnderstandOutputView.tsx: One/Echo synthesis renderer.
- GauntletOutputView.tsx: Scrutiny and elimination renderer.
- ModeSelector.tsx: Mode switching logic.
- SelectionBar.tsx: Context selection component.
- ArtifactShowcase.tsx: Visualizing Mapper Artifact components.
- ui/components/cognitive/Icons.tsx: Specialized pipeline iconography.
- ui/components/cognitive/index.ts: UI component exports.

### Explore Container System (6 Files)

_These files dynamically display the landscape based on the artifact's topology:_

- DirectAnswerContainer.tsx
- DecisionTreeContainer.tsx
- ComparisonMatrixContainer.tsx
- ExplorationSpaceContainer.tsx
- ContainerWrapper.tsx
- ui/components/cognitive/containers/index.ts

### Component Atomization (5 Files)

_Standardized cards for cognitive outputs:_

- ConsensusCard.tsx
- OutlierCard.tsx
- SouvenirCard.tsx
- GhostCard.tsx
- RawResponseCard.tsx

### Client-Side Infrastructure (2 Files)

- useCognitiveMode.ts: Transition protocol handler.
- useExperimentalFlagSync.ts: Feature flag management.

---

## 3. Major Modifications (11 Files)

1. **
    
    contract.ts**: Entirely redefined to support 
    
    MapperArtifact and specialized output schemas.
2. **
    
    parsing-utils.ts**: Implemented 3-pass semantic logic and complex JSON extraction.
3. **
    
    workflow-engine.js**: Integrated the Triage → Halt → Specialized Loop logic.
4. **
    
    PromptService.ts**: Built sophisticated multi-stage prompts for the pipeline.
5. **
    
    connection-handler.js**: Added `CONTINUE_COGNITIVE_WORKFLOW` protocol support.
6. **
    
    types/index.ts**: Updated 
    
    AiTurn to support cognitive versioning and multi-output storage.
7. **
    
    usePortMessageHandler.ts**: Routed cognitive results and managed background → UI state sync.
8. **
    
    useChat.ts**: Leveraged new cognitive primitives in workflow requests.
9. **
    
    turn-helpers.ts**: Handled complex normalization of specialized cognitive turns.
10. **
    
    streamingBuffer.ts**: Added cognitive response types for optimized streaming.
11. **
    
    AiTurnBlock.tsx**: Refactored to act as a reactive hub for specialized pipeline views.

---

## 4. Visualizing the Logic Shift

---

**Verification Summary:** All files identified above have been cross-checked against the workspace. The architecture now strictly follows the Cognitive Pipeline specification.

- **Pass 1**: Consensus Extraction (Agreement meaning, not words).
- **Pass 2**: Outlier Extraction (Unique model insights).
- **Pass 3**: Semantic Collapse (Merging synonyms).
- **Result**: A 
    
    MapperArtifact with a defined **Topology** (`high_confidence`, `dimensional`, or `contested`).

Simultaneously, the `explore-computer` analyzes this topology to determine the optimal container for display.

### Stage 3: The Cognitive Halt

Instead of overwhelming the user with a single long synthesis, the system displays the 

PostMapperView.

NOTE

This stage creates "Choice" in the UX. The user sees the topology of the answer before they see the answer itself.

### Stage 4: Specialized Execution

- **Understand Mode**: Focuses on **The One** (the dominant insight) and **The Echo** (the most compelling contrarian view). It is designed to minimize overwhelm.

## Phase H: Decider (Gauntlet) & Final Integration (Completed)

Successfully synthesized all cognitive components into a unified, switchable interface.

### Key Accomplishments:

- **Enhanced Gauntlet Parser**: Rebuilt 
    
    parseGauntletOutput in 
    
    parsing-utils.ts to support robust JSON parsing with a comprehensive text heuristic fallback.
- **Unified Hub**: Implemented 
    
    CognitiveOutputRenderer.tsx [NEW] which orchestrates the transition between the initial landscape analysis and specialized outcomes.
- **Mode Switching**: Created the 
    
    TransitionBar.tsx [NEW] and 
    
    useModeSwitching hook [NEW] to allow users to toggle between Landscape, Understand, and Decide views for any given turn.
- **Clean Integration**: Simplified 
    
    AiTurnBlock.tsx by offloading complex rendering logic to the cognitive renderer.

### Verification Results:

- [ ]  Multi-view switching verified: Users can now switch back to the Artifact Showcase even after generating an Understand synthesis.
- [ ]  Loading states verified: Clear visual feedback when transitioning between modes.
- [ ]  Parser robustness: Verified that Gauntlet results render correctly even when models omit JSON markers.

---

**Next Steps:** The core Cognitive Pipeline is now fully operational. Future iterations can focus on **Phase I: Comparison Flag (Post-MVP)** for A/B testing or further refining individual container semantics.

- **Decide (Gauntlet) Mode**: Focuses on **Scrutiny**. It tracks "Survivors" and "Eliminated" approaches, assigning confidence scores based on model cross-checks.

---

## 4. Key Data Flow Changes

### Streaming & Versioning

Cognitive outputs are now versioned (`understandVersion`, `gauntletVersion`, etc.). This allows the UI to reactively re-render only the relevant specialized views when a mode is resumed, without affecting the rest of the chat history.

### Workflow Resumption

The `CONTINUE_COGNITIVE_WORKFLOW` protocol allows the system to reach back into persistence, pull the 

MapperArtifact, and relaunch the pipeline from Stage 3, effectively maintaining state across user interactions.

---

## 5. Visual Summary: The Cognitive Stack

This walkthrough marks the completion of the foundational migration. Singularity is now a multi-modal cognitive agent.